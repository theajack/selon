/*
  bql.js
  Bind Query Library
  theajack
  http://www.theajack.com/bql/
*/
(function(){J.ready(function(){BQL.init()});var x="b-bind",_loop="b-loop",_update="b-update",_refresh="b-refresh",_callback="b-callback",_init="b-init",_each="b-each",_each_def="each",_s="{{",_e="}}",_bind_str=_s+"bind"+_e,_reg=new RegExp("("+_s+")(.*?)("+_e+")","g"),_undefined="无",_index="b-index",_attr="b-attr";function _funsResult(c,d,i){var e=[];c.funs().each(function(a){var b=J.checkArg(a(d),_undefined);e.append(b)});var f=c.str().replaceAll(_bind_str,e);if(i!=undefined){f=f.replaceAll(_index+'="i"',_index+"="+i)}return f}function _bqlRefresh(b,c){var e=b.obj();if(c===true&&e.run!=undefined){e.run()}var f="";var d=e.get();if(d==null){f=b.str().replaceAll(_bind_str,"undefined")}else{if(b.loop()){if(d!=null&&d.constructor==Array){d.each(function(a,i){f+=_funsResult(b,a,i)})}}else{f=_funsResult(b,d)}}var g=b.element();g.html(f);_bqlInitEvent(g,b.single());return d}function _bqlInitEvent(e,f){var g=e.attr(_refresh);if(e.attr(_update)=="true"){["input","textarea"].each(function(d){e.findTag(d).each(function(b){if(b.hasAttr(_attr)){var c;if(f===true){var a=b.attr(_attr);b.removeAttr(_attr);c=e.attr(x);b.on("input",function(){if(this.attr("type")=="number"){(new Function(c+".data()"+a+"="+this.val()+";"))()}else{(new Function(c+".data()"+a+"='"+this.val()+"';"))()}},true)}else if(f==false){var i=b.attr(_index);var a=b.attr(_attr);b.removeAttr(_index);b.removeAttr(_attr);c=e.attr(_loop);b.on("input",function(){if(this.attr("type")=="number"){(new Function(c+".data()["+i+"]"+a+"="+this.val()+";"))()}else{(new Function(c+".data()["+i+"]"+a+"='"+this.val()+"';"))()}},true)}else{c=e.attr(x);b.removeAttr(_attr);b.on("input",function(){if(this.attr("type")=="number"){(new Function(c+".set("+this.val()+",false);"))()}else{(new Function(c+".set('"+this.val()+"',false);"))()}},true)}if(g=="true"){b.on("change",function(){(new Function(c+".refresh();"))()},true)}}})})}}function _bqlInit(b,c){var d=b.str();var e=b.element();var f=new Array();if(b.loop()){c.varName((e.hasAttr(_each))?e.attr(_each):_each_def)}if(d.match(_reg)!=null){d.match(_reg).each(function(a){f.append(new Function(b.varName(),"return "+a.substring(_s.length,a.length-_e.length)))});c.str(d.replaceAll(_reg,_bind_str));c.funs(f)}e.empty();if(e.hasAttr(_init)){this.init((new Function("return "+e.attr(_init)))())}}function _bqlCheckRefresh(){if(_checkArg.apply(null,arguments)){return this.run()}return this}function _bqlCheckResRefresh(a,b,c){if(_checkArg.apply(null,c)){if(a.needRefresh()){this.run()}return b}return this}function _checkArg(){if(arguments.length==1){return(arguments[0]===true)}else{for(var i=0;i<arguments.length;i++){if(arguments[i]===true){return true}}return false}}function _bqlInitHtml(g,h){if(g.attr(_update)=="true"){["input","textarea"].each(function(e){var f=g.findTag(e);if(f!=undefined){f.each(function(a){var b;if(e=="input"){b=a.attr("value").trim()}else{b=a.html().trim()}a.attr("value",b);var c=b.match(_reg);if(c!=null){if(c[0]==b){var d=c[0].substring(c[0].indexOf("."),c[0].length-_e.length);a.attr(_attr,d);if(h){a.attr(_index,"i")}}}})}})}return g.html()}BQL=function(f,g){var h=f.attr(x);var i=null;var j=_bqlInitHtml(f,g);var k=f;var l=null;if(k.attr(_callback)!=""){l=new Function("obj","data",k.attr(_callback))}var m=g;var n=null;var o=new Array();var p=false;var q={varName:function(){return h},element:function(){return k},obj:function(){return i},str:function(){return j},loop:function(){return m},funs:function(){return o},single:function(){return n},needRefresh:function(){return p}};var r={varName:function(a){h=a},element:function(a){k=a},obj:function(a){i=a},str:function(a){j=a},loop:function(a){m=a},funs:function(a){o=a}};this.run=function(){var a;if(n===false){a=i.run()}else{a=i.get()}if(p){this.refresh();p=false}return a};this.refresh=function(){_bqlRefresh(q);if(l!=undefined){l.call(k,k,i.get())}};this.init=function(e){p=true;if(e==undefined){e=[]}i=Jql(e);if(e.constructor==Object){this.add=function(a,b){i.add(a,b);p=true;return this.run()};this.remove=function(a){i.remove(a);p=true;return this.run()};this.select=function(a){return i.select(a)};this.update=function(a,b){i.update(a,b);p=true;return this.run()};n=true}else if(e.constructor==Array){this.add=function(a,b,c){i.add(a,b,c);p=true;return _bqlCheckRefresh.call(this,b,c)};this.remove=function(a,b){i.remove(a,b);p=true;return _bqlCheckRefresh.call(this,a,b)};this.update=function(a,b,c){i.update(a,b,c);p=true;return _bqlCheckRefresh.call(this,b,c)};this.delete=function(a,b){i.delete(a,b);p=true;return _bqlCheckRefresh.call(this,a,b)};this.insert=function(a,b,c,d){i.insert(a,b,c,d);p=true;return _bqlCheckRefresh.call(this,b,c,d)};this.select=function(a,b){return _bqlCheckResRefresh.call(this,q,i.select(a,b),[a,b])};this.where=function(a,b,c){return _bqlCheckResRefresh.call(this,q,i.where(a,b,c),[b,c])};this.orderBy=function(a,b,c,d){return _bqlCheckResRefresh.call(this,q,i.orderBy(a,b,c,d),[b,c,d])};this.groupBy=function(a,b){return _bqlCheckResRefresh.call(this,q,i.groupBy(a,b),[b])};n=false}this.set=function(a,b){i.set(a);if(b==undefined||b===true){p=true;this.run()}return a};this.get=function(){return i.get()};this.data=function(){return i.data()};this.clear=function(){i.clear();p=true;this.run();return null};p=true;this.run();return this.get()};_bqlInit.call(this,q,r)};BQL.init=function(b,c){if(b==undefined){var d=J.attr(x);d.each(function(a){(new Function("obj","window."+a.attr(x)+"=new BQL(obj)"))(a)});var e=J.attr(_loop);e.each(function(a){(new Function("obj","window."+a.attr(_loop)+"=new BQL(obj,true)"))(a)})}else{var f="";var g="";if(b.hasAttr(x)){g=b.attr(x)}else if(b.hasAttr(_loop)){g=b.attr(x);f=",true"}else{throw new Error("对象没有b-bind或b-loop属性，不可初始化");}(new Function("obj","window."+g+"=new BQL(obj"+f+")"))(b);if(!b.hasAttr(_init)){if(c!=undefined){(new Function("d",g+".init(d)"))(c)}}return window[g]}};var y={update:"update",select:"select",delete:"delete",insert:"insert",add:"add",remove:"remove",clear:"clear",groupBy:"groupBy",desc:"desc",asc:"asc",all:"*"};var z={sum:"sum",count:"count",avg:"avg",distinct:"distinct",first:"first",last:"last",max:"max",min:"min"};function _checkString(a){if(a.constructor==String){return a.split(",")}return a}function _jqlSetAttrAndValue(a,b){var c=[];var d=[];for(var e in a){c.push(e);d.push(a[e])}b.attr(c);b.value(d)}function _jqlSelect(a,b,c,d){if(c==undefined||c.constructor==Boolean){if(d===true||c===true){return _jqlCheckReturn(a.data(),a)}c=y.all}if(a.canQuery()){b.type(y.select);b.attr(_checkString(c));return _jqlCheckRun.call(this,d)}return this};function _jqlUpdate(a,b,c,d,e){return _addAndUpdateCom.call(this,a,b,c,d,e,y.update)};function _jqlAdd(a,b,c,d,e){return _addAndUpdateCom.call(this,a,b,c,d,e,y.add)}function _addAndUpdateCom(a,b,c,d,e,f){if(a.canQuery()){b.type(f);if(c.constructor==Object){_jqlSetAttrAndValue(c,b);e=d}else{b.attr(_checkString(c));b.value(_checkString(d))}return _jqlCheckRun.call(this,d,e)}return this}function _jqlRemove(a,b,c,d){b.type(y.remove);if(c!=undefined&&c.constructor!=Boolean){b.attr(_checkString(c));return _jqlCheckRun.call(this,d)}else{b.attr(y.all);if(c.constructor==Boolean){return _jqlCheckRun.call(this,d)}}return this}function _jqlDelete(a,b,c,d){b.type(y.delete);if(c!=undefined&&c.constructor==Number){b.index(c);return _jqlCheckRun.call(this,d)}return _jqlCheckRun.call(this,c)}function _jqlInsert(a,b,c,d,e,f){b.type(y.insert);if(c.constructor==Object||c.constructor==Array){b.attr(c);if(d!=undefined){if(d.constructor==Number){b.index(d);return _jqlCheckRun.call(this,e)}else{return _jqlCheckRun.call(this,d)}}}else{b.attr(_checkString(c));b.value(_checkString(d));if(e!=undefined){if(e.constructor==Number){b.index(e);return _jqlCheckRun.call(this,f)}else{return _jqlCheckRun.call(this,e)}}}return this}function _jqlSetCondAttrAndValue(a,b){var c=[];var d=[];for(var e in a){c.push(e);d.push(a[e])}b.condAttr(c);b.condValue(d)}function _jqlWhere(a,b,c,d,e){if(a.type()===""&&a.groupAttr===""){_throw("where:使用where之前必须使用select、update、add、remove、insert、delete、groupBy方法之一");}else{if(c.constructor==Object){_jqlSetCondAttrAndValue(c,b);e=d}else{if(d!=undefined&&d.constructor==String){b.condAttr(_checkString(c));b.condValue(_checkString(d))}else{b.condAttr(c);e=d}}b.cond(true);return _jqlCheckRun.call(this,d,e)}}function _jqlCheckWhere(a,b,c){if(b.cond()){var d=b.data()[a];var e=b.condAttr();if(b.condValue().length>0){for(var i=0;i<e.length;i++){if(d[e[i]]!=b.condValue()[i]){return false}}}else{var f=_getObjectAttr(d);eval("var "+f);var g=a;var h=a;if(c!=undefined){g=c}for(var i=0;i<f.length;i++){if(e.has(f[i])){var j=d[f[i]];if(j==undefined){_throw("where:"+f[i]+"属性不存在");}else{eval(f[i]+"="+J.toString(j))}}}return eval(e)}}return true}function _getObjectAttr(a){var b=[];for(attr in a){b.push(attr)}return b}function _jqlGroupBy(a,b,c,d){if(c==undefined||c.constructor!=String){_throw("groupBy属性参数必须非空且为字符串");}else{b.groupAttr(c);return _jqlCheckRun.call(this,d)}};function _throw(a){a=J.checkArg(a,"未知异常");throw new Error(a);}function _jqlOrderBy(a,b,c,d,e,f){if(c==undefined||c.constructor!=String){_throw("orderBy属性参数必须非空且为字符串");}else{b.orderAttr(c);if(d!=undefined){if(d.constructor==String){d=d.toLowerCase();if(d=="desc"||d=="asc"){b.order(d);if(e!=undefined&&e.constructor==String){b.orderType(e)}}else{b.orderType(d)}return _jqlCheckRun.call(this,d,e,f)}return _jqlCheckRun.call(this,d)}return this}};function _getRunGroupBySelect(b,c,e){if(c){if(e[0]==y.all||e[0]==""||e.length==0){return b}var d={};if(e!=y.all&&e.length>0){e.each(function(a){d[a]=b[a]})}return d}return b}function _checkSelectAttr(a){for(var i=0;i<a.length;i++){if(a[i].has("(")){return false}}return true}function _jqlCheckReturn(a,b){if(b.single()){return J.clone(a[0])}return J.clone(a)}function _checkRunOrderBy(a,b){var c=a.orderAttr();if(c!=""){if(a.order()=="desc"){b.sortByAttr(c,a.orderType(),false)}else{b.sortByAttr(c,a.orderType())}}return b}function _checkRunGroupBy(e,f){var g=e.groupAttr();var h=e.attr();var i=[];var j=[];var k=_checkSelectAttr(h);if(g!=""){f.each(function(a){if(a.hasOwnProperty(g)){var b=j.index(a[g]);if(b==-1){j.push(a[g]);i.push([_getRunGroupBySelect(a,k,h)])}else{i[b].push(_getRunGroupBySelect(a,k,h))}}else{_throw("groupBy：元素中没有"+g+"属性");}});if(!k){var l=e.groupFuns();if(l.length>0){var m=[];i.each(function(b){var c={};var d=[];l.each(function(a){if(a.fun==undefined){if(a.attr!=g){_throw(a.attr+" 没有groupBy");}else{c[g]=b[0][g]}}else{if(a.name==y.all){if(a.fun!=z.count){_throw("* 不能用于"+a.fun+"方法");}a.name=z.count}if(!d.has(a.name)){d.push(a.name)}else{_throw(a.name+"列名不能相同");}if(a.name==a.attr){a.name=a.fun}c[a.name]=_checkGroupFunc(a,b)}});m.push(c)});return m}}return i}else{_throw("groupBy属性参数必须非空且为字符串");}}function _checkGroupFunc(a,b){switch(a.fun){case z.sum:{return _getGroupAttrArr(b,a.attr).sum()};break;case z.count:{return b.length};break;case z.avg:{return _getGroupAttrArr(b,a.attr).avg()};break;case z.first:{return b.first()[a.attr]};break;case z.last:{return b.last()[a.attr]};break;case z.max:{return _getGroupAttrArr(b,a.attr).max()};break;case z.min:{return _getGroupAttrArr(b,a.attr).min()};break;default:{return b[0][a.attr]};break}}function _getGroupAttrArr(b,c){var d=[];b.each(function(a){d.push(a[c])});return d}function _geneGroupFuns(a){if(a.timeOf(" ")>2){_throw("参数错误：select 参数空格不能多于2个");}else{var b={};if(a.has("(")&&a.has(")")){var c=a.split(")");if(c[1]!=""){b.name=c[1].substring(1)}a=c[0];c=a.split("(");b.attr=c[1].toLowerCase();if(c[1].has(" ")){c[1]=c[1].split(" ")[1]}if(!b.hasOwnProperty("name")){b.name=c[1]}b.fun=c[0].toLowerCase()}else{if(a.has(" ")){b.name=a.split(" ")[1];b.attr=a.split(" ")[0]}else{b.attr=b.name=a}}return b}}function _selectCount(b,c,d){if(c.length>1){_throw("使用count函数时select最多只能选择一列");}var e=_geneGroupFuns(c[0]);var f=0;var g;if(b.cond()===true){g=[];for(var i=0;i<d.length;i++){if(_jqlCheckWhere(i,b)){g.push(d[i])}}}else{g=d}if(e.attr.has(z.distinct)){var h=e.attr.split(" ")[1];var j=[];g.each(function(a){if(!j.has(a[h])){j.push(a[h]);f++}})}else{if(e.attr!=y.all&&e.attr!=""&&!g[0].hasOwnProperty(e.attr)){_throw("select:"+e.attr+"属性不存在");}f=g.length}if(e.name==y.all||e.name==""||e.name==e.attr){e.name=z.count}var r={};r[e.name]=f;return r}function _jqlFuncWithoutGroup(a){var b=_geneGroupFuns(a.attr()[0]);if(b.name==b.attr||b.name=="*"){b.name=b.fun}var c={};c[b.name]=_checkGroupFunc(b,a.data());return c}function _jqlRun(d,e){var f=d.data();var g=d.attr();var h=d.value();var k=d.cond();switch(d.type()){case y.select:{var l=[];var m=false;var n=[];var o=0;var p=false;if(d.groupAttr()==""){if(g.length==1&&g[0].has("(")){l=_jqlFuncWithoutGroup(d)}else{if(d.orderAttr()!=""&&!g.has(d.orderAttr())){g.push(d.orderAttr());p=true}for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){var r={};if(g==y.all){r=J.clone(f[i]);l.push(r)}else{if(g[0].has(z.count)){l=_selectCount(d,g,f);break}else{g.each(function(a,j){var b=a;if(a.has(z.count)){_throw("使用count函数时select最多只能选择一列");}if(a.has(" ")){var c=a.split(" ");if(c.length>3){_throw("select参数格式错误");}else if(c.length==3){if(c[0]!=z.distinct||j!=0){_throw("distinct必须放在第一个参数前");}m=true;b=c[2];a=c[1]}else{if(c[0]==z.distinct){if(j!=0){_throw("distinct必须放在第一个参数前");}m=true;b=a=c[1]}else{b=c[1];a=c[0]}}}if(a in f[i]){if(b in r){_throw("select:["+b+"]列名不能重复");}r[b]=f[i][a]}else{if(a.has("(")){_throw("select:没有与groupBy配合使用的聚合函数,一次只允许使用一个");}else{_throw("select参数错误,对象不包含"+a+"属性");}}});if(m){var q=J.toString(r);if(!n.has(q)){n.push(q);l.push(r)}}else{l.push(r)}}}}}_checkRunOrderBy(d,l);if(p){l=Jql(l).remove(d.orderAttr(),true)}}}else{if(d.cond()==true){for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){l.push(J.clone(f[i]))}}}else{l=J.clone(f)}var s=[];g.each(function(a){if(a.has(z.distinct)){_throw("groupBy与distinct不能共用");}s.push(_geneGroupFuns(a))});if(s.length>0){e.groupFuns(s)}l=_checkRunOrderBy(d,l);l=_checkRunGroupBy(d,l)}_jqlReset(e);return _jqlCheckReturn(l,d)};break;case y.update:{for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){g.each(function(a,j){if(f[i].hasOwnProperty(a)){f[i][a]=h[j]}else{_throw("属性不存在，若要添加新属性，请使用add方法");}})}}_jqlReset(e);return _jqlCheckReturn(f,d)};break;case y.add:{for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){g.each(function(a,j){if(!f[i].hasOwnProperty(a)){f[i][a]=h[j]}else{_throw("属性已存在，若要更新属性，请使用update方法");}})}}_jqlReset(e);return _jqlCheckReturn(f,d)};break;case y.remove:{for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){if(g==y.all){f[i]={}}else{for(var j=0;j<g.length;j++){delete f[i][g[j]]}}}}_jqlReset(e);return _jqlCheckReturn(f,d)};break;case y.insert:{var t=_jqlGeneInsertData(g,h);if(d.index()>=0){if(d.index()>=f.length){e.index(f.length-1)}if(t.constructor==Array){f.insertArray(t,d.index())}else{f.insert(t,d.index())}}else{if(t.constructor==Array){f.appendArray(t)}else{f.append(t)}}_jqlReset(e);return J.clone(f)};break;case y.delete:{if(d.index()>=0){if(_jqlCheckWhere(d.index(),d)){f.removeByIndex(d.index())}}else{var u=0;for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d,u)){f.removeByIndex(i);i--}u++}}_jqlReset(e);return J.clone(f)};break;default:{var v;if(d.cond()===true){v=[];for(var i=0;i<f.length;i++){if(_jqlCheckWhere(i,d)){v.push(J.clone(f[i]))}}}else{v=J.clone(f)}if(d.orderAttr()!=""){v=_checkRunOrderBy(d,v)}if(d.groupAttr()!=""){v=_checkRunGroupBy(d,v)}_jqlReset(e);return v};break}}function _jqlGeneInsertData(a,b){if(a.constructor==Object||a.constructor==Array&&a[0].constructor==Object){return a}else{var n=0;for(var i=0;i<b.length;i++){if(b[i].has(";")){n=b[i].timeOf(";")+1;break}}if(n==0){var c={};for(var i=0;i<a.length;i++){c[a[i]]=b[i]}return c}else{var d=[];for(var i=0;i<b.length;i++){if(b[i].has(";")){d.push(b[i].split(";"))}else{var e=[];for(var j=0;j<n;j++){e.push(b[i])}d.push(e)}}var e=[];for(var i=0;i<n;i++){var c={};for(var j=0;j<a.length;j++){c[a[j]]=d[j][i]}e.push(c)}return e}}};function _jqlInitData(a,b){if(a!=null){if(a.constructor!=Object&&a.constructor!=Array){b.canQuery(false)}}}function _jqlCheckRun(){if(_checkArg.apply(null,arguments)&&this.run!=undefined){return this.run()}return this}function _checkArg(){if(arguments.length==1){return(arguments[0]===true)}else{for(var i=0;i<arguments.length;i++){if(arguments[i]===true){return true}}return false}}function _jqlReset(a){a.attr([]);a.value([]);a.cond(false);a.condAttr([]);a.condValue([]);a.index(-1);a.sort("");a.type("");a.order("");a.orderAttr("");a.orderType("number");a.groupAttr("");a.groupFuns([])};Jql=function(a){return new JQL(a)};JQL=function(e){var f=true;var g;var h=false;if(e.constructor==Object){g=[e];h=true}else{g=e}var i=[];var j=[];var k=false;var l=[];var m=[];var n=-1;var o="";var p="";var q="";var r="";var s="number";var t="";var u=[];var v={canQuery:function(a){f=a},data:function(a){g=a},attr:function(a){i=a},value:function(a){j=a},cond:function(a){k=a},condAttr:function(a){l=a},condValue:function(a){m=a},index:function(a){n=a},sort:function(a){o=a},type:function(a){p=a},order:function(a){q=a},orderAttr:function(a){r=a},orderType:function(a){s=a},groupAttr:function(a){t=a},groupFuns:function(a){u=a}};var w={canQuery:function(){return f},data:function(){return g},attr:function(){return i},value:function(){return j},cond:function(){return k},condAttr:function(){return l},condValue:function(){return m},index:function(){return n},sort:function(){return o},type:function(){return p},single:function(){return h},order:function(){return q},orderAttr:function(){return r},orderType:function(){return s},groupAttr:function(){return t},groupFuns:function(){return u}};_jqlInitData(e,v);if(e.constructor==Object){this.add=function(a,b){_jqlAdd.call(this,w,v,a,b);return _jqlRun.call(this,w,v)};this.remove=function(a){_jqlRemove.call(this,w,v,a,true);return _jqlRun.call(this,w,v)};this.select=function(a){_jqlSelect.call(this,w,v,a,true);return _jqlRun.call(this,w,v)};this.update=function(a,b){_jqlUpdate.call(this,w,v,a,b,true);return _jqlRun.call(this,w,v)}}else if(e.constructor==Array){this.add=function(a,b,c){return _jqlAdd.call(this,w,v,a,b,c)};this.remove=function(a,b){return _jqlRemove.call(this,w,v,a,b)};this.insert=function(a,b,c,d){return _jqlInsert.call(this,w,v,a,b,c,d)};this.delete=function(a,b){return _jqlDelete.call(this,w,v,a,b)};this.select=function(a,b){return _jqlSelect.call(this,w,v,a,b)};this.update=function(a,b,c){return _jqlUpdate.call(this,w,v,a,b,c)};this.run=function(){return _jqlRun.call(this,w,v)};this.where=function(a,b,c){return _jqlWhere.call(this,w,v,a,b,c)};this.orderBy=function(a,b,c,d){return _jqlOrderBy.call(this,w,v,a,b,c,d)};this.groupBy=function(a,b){return _jqlGroupBy.call(this,w,v,a,b)}}this.set=function(a){var b=J.clone(a);if(b.constructor==Object){b=[b]}if(g.constructor!=b.constructor){_throw("数据类型不同，无法执行set");}else{g=b;return a}};this.get=function(){if(h){return J.clone(g[0])}return J.clone(g)};this.data=function(){if(h){return g[0]}return g};this.clear=function(){if(g.constructor==Array){g=[]}else if(g.constructor==Object){g={}}else{g=null}return g}}})();var BQL,JQL,Jql;